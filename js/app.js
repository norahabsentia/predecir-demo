var value, data = { "error_message": null, "forecast_params": { "agg_period": "3H", "from": "2018-07-15T00:00:00Z", "metric_name": "cpu_utilization", "to": "2018-07-16T00:00:00Z" }, "forecast_result": [{ "forecast_metadata": { "model_name": "StackedForecast", "model_version": "0.1" }, "metrics_forecast": [{ "timestamp": "2018-07-15T00:00:00Z", "value": 95.29996111026267 }, { "timestamp": "2018-07-15T03:00:00Z", "value": 94.65568189394938 }, { "timestamp": "2018-07-15T06:00:00Z", "value": 90.84631443801246 }, { "timestamp": "2018-07-15T09:00:00Z", "value": 93.51846786972783 }, { "timestamp": "2018-07-15T12:00:00Z", "value": 91.82037129984168 }, { "timestamp": "2018-07-15T15:00:00Z", "value": 90.13030300452596 }, { "timestamp": "2018-07-15T18:00:00Z", "value": 91.95562797590829 }, { "timestamp": "2018-07-15T21:00:00Z", "value": 92.7218285965874 }], "recomendation": { "action": "increase", "condition": "unhealthy" } }], "forecast_timestamp": "2018-07-16T17:01:53Z", "metrics_history": [{ "timestamp": "2018-07-02T15:00:00Z", "value": 93.722 }, { "timestamp": "2018-07-02T18:00:00Z", "value": 92.042 }, { "timestamp": "2018-07-02T21:00:00Z", "value": 93.042 }, { "timestamp": "2018-07-03T00:00:00Z", "value": 93.184 }, { "timestamp": "2018-07-03T03:00:00Z", "value": 92.642 }, { "timestamp": "2018-07-03T06:00:00Z", "value": 91.144 }, { "timestamp": "2018-07-03T09:00:00Z", "value": 94.021 }, { "timestamp": "2018-07-03T12:00:00Z", "value": 93.398 }, { "timestamp": "2018-07-03T15:00:00Z", "value": 94.03200000000001 }, { "timestamp": "2018-07-03T18:00:00Z", "value": 94.98 }, { "timestamp": "2018-07-03T21:00:00Z", "value": 95.12700000000001 }, { "timestamp": "2018-07-04T00:00:00Z", "value": 93.979 }, { "timestamp": "2018-07-04T03:00:00Z", "value": 93.686 }, { "timestamp": "2018-07-04T06:00:00Z", "value": 91.458 }, { "timestamp": "2018-07-04T09:00:00Z", "value": 92.188 }, { "timestamp": "2018-07-04T12:00:00Z", "value": 94.509 }, { "timestamp": "2018-07-04T15:00:00Z", "value": 91.542 }, { "timestamp": "2018-07-04T18:00:00Z", "value": 95.544 }, { "timestamp": "2018-07-04T21:00:00Z", "value": 94.741 }, { "timestamp": "2018-07-05T00:00:00Z", "value": 95.22 }, { "timestamp": "2018-07-05T03:00:00Z", "value": 95.194 }, { "timestamp": "2018-07-05T06:00:00Z", "value": 94.895 }, { "timestamp": "2018-07-05T09:00:00Z", "value": 94.658 }, { "timestamp": "2018-07-05T12:00:00Z", "value": 94.894 }, { "timestamp": "2018-07-05T15:00:00Z", "value": 95.24199999999999 }, { "timestamp": "2018-07-05T18:00:00Z", "value": 95.303 }, { "timestamp": "2018-07-05T21:00:00Z", "value": 94.269 }, { "timestamp": "2018-07-06T00:00:00Z", "value": 90.646 }, { "timestamp": "2018-07-06T03:00:00Z", "value": 93.05 }, { "timestamp": "2018-07-06T06:00:00Z", "value": 94.191 }, { "timestamp": "2018-07-06T09:00:00Z", "value": 94.872 }, { "timestamp": "2018-07-06T12:00:00Z", "value": 94.376 }, { "timestamp": "2018-07-06T15:00:00Z", "value": 93.98599999999999 }, { "timestamp": "2018-07-06T18:00:00Z", "value": 94.81 }, { "timestamp": "2018-07-06T21:00:00Z", "value": 94.792 }, { "timestamp": "2018-07-07T00:00:00Z", "value": 94.58000000000001 }, { "timestamp": "2018-07-07T03:00:00Z", "value": 94.235 }, { "timestamp": "2018-07-07T06:00:00Z", "value": 94.895 }, { "timestamp": "2018-07-07T09:00:00Z", "value": 93.959 }, { "timestamp": "2018-07-07T12:00:00Z", "value": 93.97999999999999 }, { "timestamp": "2018-07-07T15:00:00Z", "value": 94.812 }, { "timestamp": "2018-07-07T18:00:00Z", "value": 93.822 }, { "timestamp": "2018-07-07T21:00:00Z", "value": 93.912 }, { "timestamp": "2018-07-08T00:00:00Z", "value": 93.5 }, { "timestamp": "2018-07-08T03:00:00Z", "value": 93.801 }, { "timestamp": "2018-07-08T06:00:00Z", "value": 92.338 }, { "timestamp": "2018-07-08T09:00:00Z", "value": 89.078 }, { "timestamp": "2018-07-08T12:00:00Z", "value": 91.63900000000001 }, { "timestamp": "2018-07-08T15:00:00Z", "value": 92.61 }, { "timestamp": "2018-07-08T18:00:00Z", "value": 91.545 }, { "timestamp": "2018-07-08T21:00:00Z", "value": 25.145 }, { "timestamp": "2018-07-09T00:00:00Z", "value": 25.021 }, { "timestamp": "2018-07-09T03:00:00Z", "value": 25.097 }, { "timestamp": "2018-07-09T06:00:00Z", "value": 85.771 }, { "timestamp": "2018-07-09T09:00:00Z", "value": 91.122 }, { "timestamp": "2018-07-09T12:00:00Z", "value": 89.874 }, { "timestamp": "2018-07-09T15:00:00Z", "value": 88.819 }, { "timestamp": "2018-07-09T18:00:00Z", "value": 87.761 }, { "timestamp": "2018-07-09T21:00:00Z", "value": 88.25 }, { "timestamp": "2018-07-10T00:00:00Z", "value": 88.452 }, { "timestamp": "2018-07-10T03:00:00Z", "value": 89.687 }, { "timestamp": "2018-07-10T06:00:00Z", "value": 88.708 }, { "timestamp": "2018-07-10T09:00:00Z", "value": 92.375 }, { "timestamp": "2018-07-10T12:00:00Z", "value": 92.35499999999999 }, { "timestamp": "2018-07-10T15:00:00Z", "value": 92.812 }, { "timestamp": "2018-07-10T18:00:00Z", "value": 92.029 }, { "timestamp": "2018-07-10T21:00:00Z", "value": 91.896 }, { "timestamp": "2018-07-11T00:00:00Z", "value": 88.958 }, { "timestamp": "2018-07-11T03:00:00Z", "value": 88.598 }, { "timestamp": "2018-07-11T06:00:00Z", "value": 88.833 }, { "timestamp": "2018-07-11T09:00:00Z", "value": 87.917 }, { "timestamp": "2018-07-11T12:00:00Z", "value": 89.526 }, { "timestamp": "2018-07-11T15:00:00Z", "value": 88.167 }, { "timestamp": "2018-07-11T18:00:00Z", "value": 87.987 }, { "timestamp": "2018-07-11T21:00:00Z", "value": 87.584 }, { "timestamp": "2018-07-12T00:00:00Z", "value": 88.042 }, { "timestamp": "2018-07-12T03:00:00Z", "value": 87.86000000000001 }, { "timestamp": "2018-07-12T06:00:00Z", "value": 88.021 }, { "timestamp": "2018-07-12T09:00:00Z", "value": 87.896 }, { "timestamp": "2018-07-12T12:00:00Z", "value": 88.312 }, { "timestamp": "2018-07-12T15:00:00Z", "value": 88 }, { "timestamp": "2018-07-12T18:00:00Z", "value": 88.395 }, { "timestamp": "2018-07-12T21:00:00Z", "value": 88.181 }, { "timestamp": "2018-07-13T00:00:00Z", "value": 88.063 }, { "timestamp": "2018-07-13T03:00:00Z", "value": 87.875 }, { "timestamp": "2018-07-13T06:00:00Z", "value": 88.28999999999999 }, { "timestamp": "2018-07-13T09:00:00Z", "value": 88.30199999999999 }, { "timestamp": "2018-07-13T12:00:00Z", "value": 88.563 }, { "timestamp": "2018-07-13T15:00:00Z", "value": 88.32300000000001 }, { "timestamp": "2018-07-13T18:00:00Z", "value": 88.48 }, { "timestamp": "2018-07-13T21:00:00Z", "value": 89.71000000000001 }, { "timestamp": "2018-07-14T00:00:00Z", "value": 88.803 }, { "timestamp": "2018-07-14T03:00:00Z", "value": 93.354 }, { "timestamp": "2018-07-14T06:00:00Z", "value": 92.479 }, { "timestamp": "2018-07-14T09:00:00Z", "value": 92.625 }, { "timestamp": "2018-07-14T12:00:00Z", "value": 92.75 }, { "timestamp": "2018-07-14T15:00:00Z", "value": 89.309 }, { "timestamp": "2018-07-14T18:00:00Z", "value": 88.812 }, { "timestamp": "2018-07-14T21:00:00Z", "value": 93.208 }, { "timestamp": "2018-07-15T00:00:00Z", "value": 93.913 }, { "timestamp": "2018-07-15T03:00:00Z", "value": 95.093 }, { "timestamp": "2018-07-15T06:00:00Z", "value": 93.30600000000001 }, { "timestamp": "2018-07-15T09:00:00Z", "value": 91.906 }, { "timestamp": "2018-07-15T12:00:00Z", "value": 91.556 }, { "timestamp": "2018-07-15T15:00:00Z", "value": 91.437 }, { "timestamp": "2018-07-15T18:00:00Z", "value": 92.356 }, { "timestamp": "2018-07-15T21:00:00Z", "value": 90.03399999999999 }, { "timestamp": "2018-07-16T00:00:00Z", "value": 92.625 }, { "timestamp": "2018-07-16T03:00:00Z", "value": 94.252 }, { "timestamp": "2018-07-16T06:00:00Z", "value": 94.595 }, { "timestamp": "2018-07-16T09:00:00Z", "value": 94.56 }, { "timestamp": "2018-07-16T12:00:00Z", "value": 94.331 }, { "timestamp": "2018-07-16T15:00:00Z", "value": 95.084 }], "status": "ok", "target_server": { "id": "825cc2", "type": "ec2" }, "timestamp": "2018-07-16T17:01:53Z" };
// Save your API response in data.

(function($) {
    $("#recommendation").click(function() {

        // This the Apply Recommendation button's clickListener
        // TODO, save data of API call response into var data & then the following code will make the correct instancetype & make AJAX call accordingly.


        if (value) {
            $.ajax({
                url: 'https://load-predictor.herokuapp.com/modify',
                data: JSON.stringify({ 'instanceType': value }),
                type: 'POST',
                contentType: "application/json",
                success: function(data) {
                    alert(data);
                },
                error: function(err) {
                    console.error("FETCH INSTANCE ERR: ", err);
                }
            })
        }
    });

    $("#reset").click(function() {

        // This the Apply Recommendation button's clickListener
        // TODO, save data of API call response into var data & then the following code will make the correct instancetype & make AJAX call accordingly.


        // if (value) {
        $.ajax({
                url: 'https://load-predictor.herokuapp.com/modify',
                data: JSON.stringify({ 'instanceType': 't2.small' }),
                type: 'POST',
                contentType: "application/json",
                success: function(data) {
                    alert(data);
                },
                error: function(err) {
                    console.error("FETCH INSTANCE ERR: ", err);
                }
            })
            // }
    });

    var chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        legend: {
            display: true,
            fill: true,
            position: 'right'
        },
        pan: {
            enabled: true,
            mode: 'x',
        },
        elements: {
            point: {
                radius: 1
            }
        },

    };

    var chartDatasets = [{
            label: "History data",
            borderWidth: 1,
            fill: false,
            borderColor: 'rgb(127,127,127)',
            backgroundColor: 'rgb(127,127,127)',
            data: [],
        },
        {
            label: "Recommended data",
            borderWidth: 1,
            fill: false,
            borderColor: 'rgb(3, 169, 244)',
            backgroundColor: 'rgb(3, 169, 244)',
            data: [],
        },
        {
            label: "Prediction data",
            borderWidth: 1,
            fill: false,
            borderColor: 'rgb(33,150, 243)',
            backgroundColor: 'rgb(33,150, 243)',
            data: [],
        },
    ];

    // CPU ustilization chart
    var cpuChart = generateChart(_el('cpu-util-chart'));

    // RAM Util chart
    var ramChart = generateChart(_el('ram-util-chart'));

    // Network load chart
    var networkChart = generateChart(_el('network-load-chart'));

    // load CPU chart data
    loadData('/data/CPU_response.json', 'cpu', cpuChart);
    loadData('/data/RAM_response.json', 'ram', ramChart);
    loadData('/data/Network_response.json', 'network', ramChart);

    function loadData(url, target, chart) {
        $.ajax({
            url: url,
            // url: '/data/data.json',
            // data: dataParam,
            dataType: 'json',
            contentType: "application/json",
            success: function(data) {
                console.log(data);

                if (target === 'cpu') {
                    cpuData.history = data.metrics_history;
                    cpuData.forecast = data.forecast_result["0"].metrics_forecast;
                }

                if (target === 'ram') {
                    ramData.history = data.metrics_history;
                    ramData.forecast = data.forecast_result["0"].metrics_forecast;
                }

                if (target === 'network') {
                    networkData.history = data.metrics_history;
                    networkData.forecast = data.forecast_result["0"].metrics_forecast;
                }

                if (!isEmpty(cpuData) && !isEmpty(ramData) && !isEmpty(networkData)) {
                    handleData();
                }

            },
            error: function(err) {
                console.log(err);
            }
        });
    }
    var loopDelay = 2000;

    var theLoop;
    var index = 0;
    var cpuData = {};
    var ramData = {};
    var networkData = {};

    $('#timeline-slider').on('change', function() {
        $this = $(this);

        loopDelay = 2000 - $this.val();
        console.log($this.val(), loopDelay)
    })

    function allChartData() {

    }

    function handleData() {
        theLoop = setTimeout(function() {
            // cpu data chart update
            cpuChart.data.labels.push(cpuData.history[index].timestamp.replace('Z', ''));

            if (cpuData.history[index]) {
                cpuChart.data.datasets[0].data.push({
                    y: cpuData.history[index].value,
                    x: cpuData.history[index].timestamp.replace('Z', '')
                });
            }

            if (cpuData.forecast[index]) {
                cpuChart.data.datasets[0].data.push({
                    y: cpuData.forecast[index].value,
                    x: cpuData.forecast[index].timestamp.replace('Z', '')
                });
            }

            //ram data chart update
            ramChart.data.labels.push(ramData.history[index].timestamp.replace('Z', ''));
            if (ramData.history[index]) {
                ramChart.data.datasets[2].data.push({
                    y: ramData.history[index].value,
                    x: ramData.history[index].timestamp.replace('Z', '')
                });
            }
            if (ramData.forecast[index]) {
                ramChart.data.datasets[2].data.push({
                    y: ramData.forecast[index].value,
                    x: ramData.forecast[index].timestamp.replace('Z', '')
                });
            }

            //network data chart update
            networkChart.data.labels.push(networkData.history[index].timestamp.replace('Z', ''));
            if (networkData.history[index]) {
                networkChart.data.datasets[2].data.push({
                    y: networkData.history[index].value,
                    x: networkData.history[index].timestamp.replace('Z', '')
                });
            }
            if (networkData.forecast[index]) {
                networkChart.data.datasets[2].data.push({
                    y: networkData.forecast[index].value,
                    x: networkData.forecast[index].timestamp.replace('Z', '')
                });
            }

            if (cpuData.history[index] || cpuData.forecast[index]) {
                cpuChart.update();
            }

            if (ramData.history[index] || ramData.forecast[index]) {
                ramChart.update();
            }

            if (networkData.history[index] || networkData.forecast[index]) {
                networkChart.update();
            }

            index++;
            handleData();
        }, loopDelay);
    }

    function generateChart(chartEl) {
        var ctx = chartEl.getContext('2d');
        ctx.height = 300;
        var chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: chartDatasets
            },
            options: chartOptions
        });

        return chart;
    }

    function _el(id) {
        return document.getElementById(id);
    }

    function isEmpty(obj) {
        for (var prop in obj) {
            if (obj.hasOwnProperty(prop))
                return false;
        }
        return true;
    }
    // Counter code


    $('.btn-number').click(function(e) {
        e.preventDefault();

        fieldName = $(this).attr('data-field');
        type = $(this).attr('data-type');
        var input = $("input[name='" + fieldName + "']");
        var currentVal = parseInt(input.val());
        if (!isNaN(currentVal)) {
            if (type == 'minus') {

                if (currentVal > input.attr('min')) {
                    input.val(currentVal - 1).change();
                }
                if (parseInt(input.val()) == input.attr('min')) {
                    $(this).attr('disabled', true);
                }

            } else if (type == 'plus') {

                if (currentVal < input.attr('max')) {
                    input.val(currentVal + 1).change();
                }
                if (parseInt(input.val()) == input.attr('max')) {
                    $(this).attr('disabled', true);
                }

            }
        } else {
            input.val(0);
        }
    });
    $('.input-number').focusin(function() {
        $(this).data('oldValue', $(this).val());
    });
    $('.input-number').change(function() {

        minValue = parseInt($(this).attr('min'));
        maxValue = parseInt($(this).attr('max'));
        valueCurrent = parseInt($(this).val());

        name = $(this).attr('name');
        if (valueCurrent >= minValue) {
            $(".btn-number[data-type='minus'][data-field='" + name + "']").removeAttr('disabled')
        } else {
            alert('Sorry, the minimum value was reached');
            $(this).val($(this).data('oldValue'));
        }
        if (valueCurrent <= maxValue) {
            $(".btn-number[data-type='plus'][data-field='" + name + "']").removeAttr('disabled')
        } else {
            alert('Sorry, the maximum value was reached');
            $(this).val($(this).data('oldValue'));
        }


    });
    $(".input-number").keydown(function(e) {
        // Allow: backspace, delete, tab, escape, enter and .
        if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 190]) !== -1 ||
            // Allow: Ctrl+A
            (e.keyCode == 65 && e.ctrlKey === true) ||
            // Allow: home, end, left, right
            (e.keyCode >= 35 && e.keyCode <= 39)) {
            // let it happen, don't do anything
            return;
        }
        // Ensure that it is a number and stop the keypress
        if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
            e.preventDefault();
        }
    });
    // End of counter code.
})(jQuery)
